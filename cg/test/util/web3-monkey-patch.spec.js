const Web3 = require('web3');
const QuorumContract = require('./../../src/utils/blockchain/quorum-contract');
const abi = require('../../src/utils/blockchain/contract-abi');
const web3ProviderFactory = require('../../src/utils/blockchain/web3-provider-factory');
const web3 = new Web3(web3ProviderFactory());

let quorum;

beforeAll(async () => {
  quorum = new QuorumContract(web3, abi);
  await quorum.deploy(
    '0x608060405234801561001057600080fd5b50336000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506112f3806100606000396000f3006080604052600436106100c4576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff168062091988146100c95780630c1e947f146101245780634c3e99721461019a57806352843d51146102265780636017cf4c1461029957806362b8b30014610302578063785779d01461038057806391bd7223146103c9578063a3514e4a1461043c578063ae0ef4b4146104ba578063bd92ccee14610538578063c24b846f14610581578063f77c479114610607575b600080fd5b3480156100d557600080fd5b5061010a600480360381019080803573ffffffffffffffffffffffffffffffffffffffff16906020019092919050505061065e565b604051808215151515815260200191505060405180910390f35b34801561013057600080fd5b506101806004803603810190808035600019169060200190929190803573ffffffffffffffffffffffffffffffffffffffff169060200190929190803560ff169060200190929190505050610701565b604051808215151515815260200191505060405180910390f35b3480156101a657600080fd5b5061020c60048036038101908080356000191690602001909291908035906020019082018035906020019080806020026020016040519081016040528093929190818152602001838360200280828437820191505050505050919291929050505061078a565b604051808215151515815260200191505060405180910390f35b34801561023257600080fd5b506102756004803603810190808035600019169060200190929190803573ffffffffffffffffffffffffffffffffffffffff169060200190929190505050610a8a565b6040518082600281111561028557fe5b60ff16815260200191505060405180910390f35b3480156102a557600080fd5b506102e86004803603810190808035600019169060200190929190803573ffffffffffffffffffffffffffffffffffffffff169060200190929190505050610afd565b604051808215151515815260200191505060405180910390f35b34801561030e57600080fd5b5061036660048036038101908080359060200190820180359060200190808060200260200160405190810160405280939291908181526020018383602002808284378201915050505050509192919290505050610b90565b604051808215151515815260200191505060405180910390f35b34801561038c57600080fd5b506103af6004803603810190808035600019169060200190929190505050610c82565b604051808215151515815260200191505060405180910390f35b3480156103d557600080fd5b506103de610d9e565b6040518080602001838152602001828103825284818151815260200191508051906020019060200280838360005b8381101561042757808201518184015260208101905061040c565b50505050905001935050505060405180910390f35b34801561044857600080fd5b506104a060048036038101908080359060200190820180359060200190808060200260200160405190810160405280939291908181526020018383602002808284378201915050505050509192919290505050610e39565b604051808215151515815260200191505060405180910390f35b3480156104c657600080fd5b5061051e60048036038101908080359060200190820180359060200190808060200260200160405190810160405280939291908181526020018383602002808284378201915050505050509192919290505050610f38565b604051808215151515815260200191505060405180910390f35b34801561054457600080fd5b506105676004803603810190808035600019169060200190929190505050610f8b565b604051808215151515815260200191505060405180910390f35b34801561058d57600080fd5b506105b06004803603810190808035600019169060200190929190505050610fc0565b6040518080602001828103825283818151815260200191508051906020019060200280838360005b838110156105f35780820151818401526020810190506105d8565b505050509050019250505060405180910390f35b34801561061357600080fd5b5061061c6111d5565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b600080600090505b6001805490508110156106f6578273ffffffffffffffffffffffffffffffffffffffff1660018281548110151561069957fe5b9060005260206000200160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614156106e957600191506106fb565b8080600101915050610666565b600091505b50919050565b60008160026000866000191660001916815260200190815260200160002060010160008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff0219169083600281111561077a57fe5b0217905550600190509392505050565b6000806000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161415156107e857600080fd5b836000151560026000836000191660001916815260200190815260200160002060000160009054906101000a900460ff16151514151561082757600080fd5b61083084610f38565b151561083b57600080fd5b600091505b600180549050821015610910576000600260008760001916600019168152602001908152602001600020600101600060018581548110151561087e57fe5b9060005260206000200160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff021916908360028111156108fe57fe5b02179055508180600101925050610840565b600091505b83518210156109bf5760016002600087600019166000191681526020019081526020016000206001016000868581518110151561094e57fe5b9060200190602002015173ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff021916908360028111156109ad57fe5b02179055508180600101925050610915565b600060026000876000191660001916815260200190815260200160002060000160006101000a81548160ff0219169083151502179055507f17b46fe72172b70500853bedb3b5ba16a452a4734c92f74d2aed8a260c8e5392858560405180836000191660001916815260200180602001828103825283818151815260200191508051906020019060200280838360005b83811015610a6a578082015181840152602081019050610a4f565b50505050905001935050505060405180910390a160019250505092915050565b600060026000846000191660001916815260200190815260200160002060010160008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff16905092915050565b6000610b083361065e565b1515610b1357600080fd5b7f7adbefd4047a6b3fc04baed7453752b4eceb772d9036d0006014fc9cfa9af75683836040518083600019166000191681526020018273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019250505060405180910390a16001905092915050565b60008060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16141515610bed57600080fd5b610bf682610e39565b1515610c0157600080fd5b7fa5ce10be54b4ef0d5b03c912f8855709209175079c70907491e4ab39606cc7b6826040518080602001828103825283818151815260200191508051906020019060200280838360005b83811015610c66578082015181840152602081019050610c4b565b505050509050019250505060405180910390a160019050919050565b60008060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16141515610cdf57600080fd5b816000151560026000836000191660001916815260200190815260200160002060000160009054906101000a900460ff161515141515610d1e57600080fd5b600160026000856000191660001916815260200190815260200160002060000160006101000a81548160ff0219169083151502179055507f6035499ce5e80742180c62be06aea6c0cce9f0df624f498b9709a79adc8fb9968360405180826000191660001916815260200191505060405180910390a16001915050919050565b606060006001808054905081805480602002602001604051908101604052809291908181526020018280548015610e2a57602002820191906000526020600020905b8160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019060010190808311610de0575b50505050509150915091509091565b600080600090505b82518160ff161015610ed0576000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16838260ff16815181101515610e9657fe5b9060200190602002015173ffffffffffffffffffffffffffffffffffffffff1614151515610ec357600080fd5b8080600101915050610e41565b8251604051908082528060200260200182016040528015610f005781602001602082028038833980820191505090505b5060019080519060200190610f169291906111fa565b508260019080519060200190610f2d9291906111fa565b506001915050919050565b600080600090505b8251811015610f8157610f698382815181101515610f5a57fe5b9060200190602002015161065e565b1515610f7457600080fd5b8080600101915050610f40565b6001915050919050565b600060026000836000191660001916815260200190815260200160002060000160009054906101000a900460ff169050919050565b60608060008060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614151561102057600080fd5b836000151560026000836000191660001916815260200190815260200160002060000160009054906101000a900460ff16151514151561105f57600080fd5b6001805490506040519080825280602002602001820160405280156110935781602001602082028038833980820191505090505b509250600091505b60018054905082101561118b5760026000866000191660001916815260200190815260200160002060010160006001848154811015156110d757fe5b9060005260206000200160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff16838381518110151561115857fe5b90602001906020020190600281111561116d57fe5b9081600281111561117a57fe5b81525050818060010192505061109b565b7f5cee2268933cd873c783419e5be7668e121517767fe669a5a703b09426b138158560405180826000191660001916815260200191505060405180910390a1829350505050919050565b6000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b828054828255906000526020600020908101928215611273579160200282015b828111156112725782518260006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055509160200191906001019061121a565b5b5090506112809190611284565b5090565b6112c491905b808211156112c057600081816101000a81549073ffffffffffffffffffffffffffffffffffffffff02191690555060010161128a565b5090565b905600a165627a7a723058206926eeaa89ee7628c31e9c3d6b8c648f4cce4a6a95dbd350dc4b60f5e7bdab0a0029'
  );
});

describe('Web3 monkey patch', () => {
  it('should allow the events to fire without crashing', async done => {
    const subjectId = web3.utils.sha3('12929292992');
    expect.assertions(2);

    quorum.contract.events.allEvents([], (err, data) => {
      expect(err).toBeNull();
      expect(data.returnValues.subjectIdHash).toEqual(subjectId);
      done();
    });

    await quorum.performMethod('recordConsentGivenTo', [subjectId, []]);
  });
});
